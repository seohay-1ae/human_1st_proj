<!doctype html>
<html lang="ko">
	<head>
		<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
		<link rel="stylesheet" href="styles.css" />
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>커뮤니티 게시판</title>
		<style>
			html,
			body {
				height: 100%;
				margin: 0;
				padding: 0;
			}

			body {
				background-color: #f4f4f4;
				display: flex;
				flex-direction: column;
			}

			.wrapper {
				flex: 1;
				display: flex;
				flex-direction: column;
				align-items: center;
				padding: 20px;
				margin-top: 100px;
			}

			.container {
				width: 90%;
				max-width: 1000px;
				margin: auto;
				background: #f4f4f4;
				padding: 20px;
				box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
				border-radius: 10px;
			}

			.header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 20px;
			}

			.header h3 {
				margin: 0;
				color: #333;
			}

			.write-button {
				color: white;
				padding: 10px 20px;
				font-size: 1rem;
				border: none;
				border-radius: 8px;
				text-decoration: none;
				font-weight: bold;
				transition: background-color 0.3s;
				display: inline-block;
				background-color: #0a8b11;
			}

			.search-container {
				margin: 20px 0;
				display: flex;
				justify-content: flex-start;
			}

			.search-input {
				padding: 10px;
				font-size: 1rem;
				border: 1px solid #ccc;
				border-radius: 5px;
				width: 300px;
			}

			table {
				width: 100%;
				border-collapse: collapse;
				text-align: left;
			}

			th,
			td {
				padding: 12px;
				border-bottom: 1px solid #ddd;
			}

			th {
				background-color: #f0f0f0;
			}

			tr:hover {
				background-color: #f9f9f9;
			}

			a {
				text-decoration: none;
				color: #000;
			}

			.delete-button {
				background-color: red;
				color: white;
				border: none;
				border-radius: 5px;
				padding: 5px 10px;
				cursor: pointer;
			}
		</style>
	</head>
	<body>
		<div class="wrapper">
			<div class="container">
				<div class="header">
					<h3>커뮤니티 게시판</h3>
					<a href="/community/write.html" class="write-button">글쓰기</a>
				</div>

				<div class="search-container">
					<input type="text" id="search" class="search-input" placeholder="게시글 검색..." />
				</div>

				<table>
					<thead>
						<tr>
							<th>NO.</th>
							<th>제목</th>
							<th>작성자</th>
							<th>작성일</th>
							<!-- 삭제 버튼 열 (JS에서 조건부로 추가) -->
						</tr>
					</thead>
					<tbody id="post-list">
						<!-- 게시글 목록 렌더링 -->
					</tbody>
				</table>
			</div>
		</div>

		<script>
			$(document).ready(function () {
				let posts = JSON.parse(localStorage.getItem('posts')) || [];
				const currentUser = JSON.parse(localStorage.getItem('loggedInUser'));

				// 관리자일 경우 삭제 열 추가
				// currentUser && currentUser.id === 'admin' 넣는 이유
				// const currentUser = JSON.parse(localStorage.getItem('loggedInUser')); 가 null이면
				// currentUser.id === 'admin' 에서 TypeError: Cannot read properties of null (reading 'id') 에러 발생
				// if (currentUser && currentUser.id === 'admin') 이렇게 하면
				// currentUser가 null일 경우 조건식 자체가 false가 되면서 뒤에 .id를 읽으려 하지 않고 에러 없이 그냥 넘어감
				if (currentUser && currentUser.id === 'admin') {
					$('thead tr').append('<th>삭제</th>');
				}

				// 게시글 목록 표시 함수
				function displayPosts(filteredPosts) {
					$('#post-list').empty();
					filteredPosts
						.slice()
						.reverse()
						.forEach((post, index) => {
							// 삭제 버튼 누를 때
							const indexToDelete = $(this).data('index');
							const postIdToDelete = posts[indexToDelete].id;
							posts = posts.filter((post) => post.id !== postIdToDelete);

							const reportCountTag =
								currentUser && currentUser.id === 'admin' && post.reportCount > 0
									? `<span style="color: red;"> (신고 ${post.reportCount})</span>`
									: '';

							$('#post-list').append(`<tr><td>${filteredPosts.length - index}</td>
                <td><a href="post.html?index=${realIndex}">${post.title}</a>${reportCountTag}</td>
                <td>${post.author}</td>
                <td>${post.date}</td>
                ${
									currentUser && currentUser.id === 'admin'
										? `<td><button class="delete-button" data-index="${realIndex}">삭제</button></td>`
										: ''
								}
                    </tr>`);
						});
				}

				displayPosts(posts);

				$('#search').on('input', function () {
					const searchQuery = $(this).val().toLowerCase();
					const filteredPosts = posts.filter((post) => {
						return (
							post.title.toLowerCase().includes(searchQuery) ||
							post.content.toLowerCase().includes(searchQuery)
						);
					});
					displayPosts(filteredPosts);
				});

				$(document).on('click', '.delete-button', function () {
					const indexToDelete = $(this).data('index');
					if (confirm('정말 삭제하시겠습니까?')) {
						posts.splice(indexToDelete, 1);
						localStorage.setItem('posts', JSON.stringify(posts));
						location.reload();
					}
				});
			});
		</script>

		<!-- 공통 헤더 및 푸터 스크립트 로드 (바디 맨 아래에 삽입)-->
		<script defer src="../common/header3.js"></script>
		<script defer src="../common/footer2.js"></script>
	</body>
</html>
